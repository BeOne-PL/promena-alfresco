# Promena Alfresco Development Guide
## Connector
A custom connector can be provided by implementing [`PromenaTransformationExecutor`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/PromenaTransformationExecutor.kt) and registering it as a bean. 

The typical flow that a connector should implement:
1. Validate `postTransformationExecutor` [[`PostTransformationExecutorValidator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/post/PostTransformationExecutorValidator.kt), [`SerializationPostTransformationExecutorValidator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/internal/transformation/post/SerializationPostTransformationExecutorValidator.kt) implementation, `serializationPostTransformationExecutorValidator` bean name]
2. Check if the nodes from `nodeDescriptor` have been modified in the current transaction [[`NodeInCurrentTransactionVerifier`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/NodeInCurrentTransactionVerifier.kt), [`DefaultNodeInCurrentTransactionVerifier`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/DefaultNodeInCurrentTransactionVerifier.kt) implementation, `defaultNodeInCurrentTransactionVerifier` bean name]
3. Generate a checksum of `nodeDescriptor` [[`NodesChecksumGenerator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/NodesChecksumGenerator.kt), [`RenditionContentNodesChecksumGenerator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/RenditionContentNodesChecksumGenerator.kt) implementation, `renditionContentNodesChecksumGenerator` bean name]
4. Convert `nodeDescriptor` to [`DataDescriptor`](/Users/skotar/Projekty/Promena/promena/base/promena-transformer/contract/src/main/kotlin/pl/beone/promena/transformer/contract/data/DataDescriptor.kt) [[`DataDescriptorGetter`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/DataDescriptorGetter.kt), [`ContentPropertyDataDescriptorGetter`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/ContentPropertyDataDescriptorGetter.kt) implementation, `contentPropertyDataDescriptorGetter` bean name]
5. Start a new transformation execution [[`PromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/PromenaTransformationManager.kt), [`MemoryWithAlfrescoPersistencePromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/transformation/manager/MemoryWithAlfrescoPersistencePromenaMutableTransformationManager.kt) implementation, `memoryWithAlfrescoPersistencePromenaMutableTransformationManager` bean name]
6. Add [`PROPERTY_EXECUTION_IDS`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/applicationmodel/model/PromenaModel.kt) to the  nodes from `nodeDescriptor`
7. Perform the transaction asynchronously
8. Return [`TransformationExecution`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/applicationmodel/transformation/TransformationExecution.kt) from step 6

The flow of an asynchronous transaction execution:
1. **Perform the transformation on Promena depending on the connector** - *your task*
2. Verify if the nodes from `nodeDescriptor` still exist [[`NodesExistenceVerifier`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/NodesExistenceVerifier.kt), [`DefaultNodesExistenceVerifier`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/DefaultNodesExistenceVerifier.kt) implementation, `defaultNodesExistenceVerifier` bean name]
3. Check if the checksum of the nodes from `nodeDescriptor` haven't changed [[`NodesChecksumGenerator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/NodesChecksumGenerator.kt), [`RenditionContentNodesChecksumGenerator`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/RenditionContentNodesChecksumGenerator.kt) implementation, `renditionContentNodesChecksumGenerator` bean name]
4. Save the results of the transformation execution [[`TransformedDataDescriptorSaver`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/node/TransformedDataDescriptorSaver.kt), [`MinimalRenditionTransformedDataDescriptorSaver`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/node/MinimalRenditionTransformedDataDescriptorSaver.kt) implementation, `minimalRenditionTransformedDataDescriptorSaver` bean name]
5. Inject dependencies into `postTransformationExecutor` and run it if set [[`PostTransformationExecutorInjector`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/post/PostTransformationExecutorInjector.kt), [`ReflectionPostTransformationExecutorInjector`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/transformation/post/ReflectionPostTransformationExecutorInjector.kt) implementation, `reflectionPostTransformationExecutorInjector` bean name]
6. Clean data [[`DataCleaner`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/data/DataCleaner.kt), [`DefaultDataCleaner`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/internal/data/DefaultDataCleaner.kt) implementation, `defaultDataCleaner` bean name]
7. Complete the transformation execution with the result [[`PromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/PromenaTransformationManager.kt), [`MemoryWithAlfrescoPersistencePromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/transformation/manager/MemoryWithAlfrescoPersistencePromenaMutableTransformationManager.kt) implementation, `memoryWithAlfrescoPersistencePromenaMutableTransformationManager` bean name]
8. In case of an error, another execution is run until the number of [`Retry.maxAttempts`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/applicationmodel/retry/Retry.kt) is reached.
   If the number is reached, it completes the transformation execution with an exception [[`PromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/PromenaTransformationManager.kt), [`MemoryWithAlfrescoPersistencePromenaMutableTransformationManager`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/external/transformation/manager/MemoryWithAlfrescoPersistencePromenaMutableTransformationManager.kt) implementation, `memoryWithAlfrescoPersistencePromenaMutableTransformationManager` bean name]

### Example
* [`HttpPromenaTransformationExecutor`](./connector/alfresco-promena-connector-http/src/main/kotlin/pl/beone/promena/alfresco/module/connector/http/external/HttpPromenaTransformationExecutor.kt)
* [`ActiveMQPromenaTransformationExecutor`](./connector/alfresco-promena-connector-activemq/src/main/kotlin/pl/beone/promena/alfresco/module/connector/activemq/external/transformation/ActiveMQPromenaTransformationExecutor.kt) [[`TransformerSender`](./connector/alfresco-promena-connector-activemq/src/main/kotlin/pl/beone/promena/alfresco/module/connector/activemq/delivery/activemq/TransformerSender.kt), [`TransformerResponseConsumer`](./connector/alfresco-promena-connector-activemq/src/main/kotlin/pl/beone/promena/alfresco/module/connector/activemq/delivery/activemq/TransformerResponseConsumer.kt), [`TransformerResponseErrorConsumer`](./connector/alfresco-promena-connector-activemq/src/main/kotlin/pl/beone/promena/alfresco/module/connector/activemq/delivery/activemq/TransformerResponseErrorConsumer.kt)]

## Metadata saver
A custom metadata saver can be provided by implementing [`PromenaTransformationMetadataSaver`](./alfresco-promena-core/src/main/kotlin/pl/beone/promena/alfresco/module/core/contract/transformation/PromenaTransformationMetadataSaver.kt) and registering as a bean.

All registered metadata savers are executed after saving the results of a transformation execution.

### Example
* [`RenditionPromenaTransformationMetadataSaver`](./transformer-rendition/alfresco-promena-lib-transformer-rendition/src/main/kotlin/pl/beone/promena/alfresco/lib/transformerrendition/external/rendition/transformation/RenditionPromenaTransformationMetadataSaver.kt)
* [`BarcodeDetectorPromenaTransformationMetadataSaver`](https://github.com/BeOne-PL/promena-transformer-barcode-detector-metadata-alfresco/blob/master/src/main/kotlin/pl/beone/promena/alfresco/module/transformer/barcodedetector/external/transformation/BarcodeDetectorPromenaTransformationMetadataSaver.kt)
   
## Definition
### Rendition
A custom rendition definition can be provided by implementing [`PromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-lib-transformer-rendition/src/main/kotlin/pl/beone/promena/alfresco/lib/transformerrendition/contract/rendition/definition/PromenaRenditionDefinition.kt) and registering it as a bean. 

It is the equivalent of [`ThumbnailDefinition`](https://github.com/Alfresco/alfresco-repository/blob/alfresco-repository-7.43/src/main/java/org/alfresco/repo/thumbnail/ThumbnailRegistry.java) in Promena environment.

#### Example
* [`Avatar32PromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/image/Avatar32PromenaRenditionDefinition.kt)
* [`AvatarPromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/image/AvatarPromenaRenditionDefinition.kt)
* [`ImgPreviewPromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/image/ImgPreviewPromenaRenditionDefinition.kt)
* [`DocLibPromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/image/DocLibPromenaRenditionDefinition.kt)
* [`MediumPromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/image/MediumPromenaRenditionDefinition.kt)
* [`PdfPromenaRenditionDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/rendition/definition/pdf/PdfPromenaRenditionDefinition.kt)

### Content Transformer
A custom content transformer definition can be provided by implementing [`PromenaContentTransformerDefinition`](./transformer-rendition/alfresco-promena-lib-transformer-rendition/src/main/kotlin/pl/beone/promena/alfresco/lib/transformerrendition/contract/transformer/definition/PromenaContentTransformerDefinition.kt) and registering it as a bean. 

It provides the equivalent to Alfresco Content Transformer in Promena environment and it is used by [ContentTransformerRegistry](https://github.com/Alfresco/alfresco-repository/blob/alfresco-repository-7.43/src/main/java/org/alfresco/repo/content/transform/ContentTransformerRegistry.java) to perform a transformation (visit [Content Transformers (and Renditions)](https://docs.alfresco.com/6.2/references/dev-extension-points-content-transformer.html) for more details).

### Example
* [`DocumentPromenaContentTransformerDefinition`](./transformer-rendition/alfresco-promena-transformer-rendition-predefined/src/main/kotlin/pl/beone/promena/alfresco/module/transformerrendition/predefined/internal/transformer/definition/DocumentPromenaContentTransformerDefinition.kt)